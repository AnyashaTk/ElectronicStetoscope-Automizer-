# ML System Design Doc - [RU]
## Дизайн ML системы - Electronic Stetoscope Automizer MVP 0.1.0

*Автоматизация обнаружения патологий сердца с помощью данных с электронного стетоскопа*

> ### Термины и пояснения
> - Аускультация - метод диагностики, при котором с помощью стетоскопа слушают звуки, издаваемые сердцем, для оценки его работы, выявления заболеваний и аномалий
> - Спектограмма - изображение, показывающее зависимость спектральной плотности мощности сигнала от времени

### 1. Цели и предпосылки
#### 1.1. Зачем идем в разработку продукта?

- Product Owner для данного продукта это центр Альбрехта. В качестве бизнес метрик будет измеряться медицинская основная метрика - эффективность улучшения качества жизни пациентов
- Большинство врачей не имеют достаточно опыта для определения патологий сердца при `аускультации`, поэтому для более точного анализа требуется автоматический классификатор 
- Успехом данного проекта является разработанный алгоритм классификации наличия патологии. В лучшем случае будет передан на клинические испытания электронный стетоскоп со встроенным алгоритмом распознавания всех видов патологий 

#### 1.2. Бизнес-требования и ограничения  

- Алгоритм должен принимать на вход аудиофайл с записью с электростетоскопа, на выходе возвращать либо значения 1\0, либо в лучшем случае вектор со значениями 1\0 для каждой патологии  
- Проект должен иметь возможность работать локально, без использования гпу
- В течение первой итерации ожидается MVP продукта из алгоритма бинарной классификации и одностраничного сайта для возможности тестирования алгоритма 
- Алгоритм будет использоваться для исследований центра Альбрехта и создания нового медицинского прибора
- Опираться в первую очередь будем на метрики: для бинарной классификации точность 0.9 и выше, так как в [задачах подобного рода](https://www.imrpress.com/journal/RCM/24/6/10.31083/j.rcm2406175) это не является редким результатом
- Отношение сигнал/шум (SNR) после очистки данныхЦелевое значение: SNR > 20 дБ, удаление речи > 95%
- Точность определения пульса определяем через RMSE значение, целевое - RMSE < 3 удара в минуту
- Так же будем отслеживать метрики Recall(>0.85), Precision(>0.8) и Specificity(>0.7), в данном случае нам важнее не упустить пациентов, которых нужно дополнительно обследовать на наличие патологии, чем предложить здоровому пациенту дообследоваться (аускультация никогда не является единственным фактором для выставления диагноза)
- Для multilabel классификации проще всего будет использовать в качестве единой метрики будет выступать взвешенная f1 мера, и в качестве более подробного набора метрик - матрица ошибок каждого класса.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   
  
- В первую итерацию входит EDA данных, полученных от Product Owner, анализ открытых датасетов, планирование и проведение экспериментов по предобработке данных и классификации наличия патологий
- По итогам итерации клиенту будет передан репозиторий с сервисом для поднятия одностраничного сайта для обработки аудиофайлов, полученных с помощью электронного стетоскопа, и веса модели. Алгоритмы обучения модели клиенту не требуются на данный момент
- Дальнейшие разработки включают в себя улучшение качества предобработки данных и классификации, поднятие метрик, расширение количества или видов патологий. Помощь со встраиванием алгоритма в новое устройство, на данный момент они не входят в скоуп задач  

### 2. Методология `Data Scientist`     

#### 2.1. Постановка задачи  

Для составления решения будут разработаны и проверены:
- Алгоритм очистки данных от участков с человеческой речью (SNR > 20 дБ, удаление речи > 95%)
- Алгоритм подсчета пульса (RMSE < 3 удара в минуту)
- Алгоритм бинарной классификации наличия патологий (Recall(>0.85), Precision(>0.8) и Specificity(>0.7))
- Сервис с одностраничным сайтом для работы с аудиофайлами (Планируется использовать FastApi)
- Документация по работе с сайтом (.md)

#### 2.1. Блок-схема решения

Бейзлайн планируется реализовать следующим образом:

<image src="/docs/images/baseline.png" alt="Baseline scheme">

#### 2.2 Подготовка данных

В качестве основных данных будут использоваться записи, собранные клиентом, будем называть его ACD(Albrehth Created Dataset)
Данные обновляются раз в несколько месяцев в течение разработки проекта.

**Характеристики датасета ACD:**
- количество данных всключает в себя всего 51 запись от 30 до 70 секунд
- большая часть данных имеет длительность около 40-50 секунд, полностью поддающихся классификации
- sample rate имеющихся данных 22050
- все файлы хранятся в формате wav
- файлы имеют название, соответствующее ФИО пациента из таблицы пациентов
- в таблице пациентов хранятся данные обо всех возможных патологиях сердца, выявляемых с помощью аудио, с учетом степени патологии 

**Проблемы, связанные с датасетом:**
- Есть ощутимая нехватка данных 
- Есть серьезный дисбаланс классов для задачи бинарной классификации (3 семпла здорового пациента, 48 больных, из-за разности видов заболеваний для мультилейбл классификации дисбаланса нет)
- В названиях файлов и таблице пациентов имеется конфидициальная информация - ФИО пациентов

**Решение проблем:**
- Требуется дополнительно использовать открытые датасеты, при надобности отдать на доразметку по нашей задаче действующим врачам со стороны клиента
- Можно использовать некоторые виды аугментации аудио данных, самым простым будет изменение громкости звука
- Для первых итераций будут использоваться открытые модели, до 90% ACD будет использоваться в качестве тестового датасета 
- Для сокрытия конфидициальной информации все названия файлов будут заменены на индексы, соответствующие номеру пациента в таблице, а ФИО в таблице будет удалено
- Сами данные находятся под NDA, к доступу разрешены только 2 семпла для возможности проверки работы сервиса извне

**Датасет CDPD - [The CirCor DigiScope Phonocardiogram Dataset](https://www.physionet.org/content/circor-heart-sound/1.0.1/)**
- датасет открытый, доступный для обучения новых моделей с 2022-го года
- собран на другой модели стетоскопа, что может помешать качеству работы сервиса(тк он будет ориентирован на используемую для ACD датасета)
- содержит более 1568 данных для обучения, от 4 до 80 секунд, каждая запись - исследование одного пациента, однако один пациент может иметь несколько записей либо в train либо в val наборе
- все записи есть в wav формате
- для последующих этапов разработки требуется подробный анализ датасета экспертами-терапевтами, данные отданы заказчику для анализа, до получения результатов возможно решение задачи только для бинарной классификации наличия патологии, что требуется для mvp прототипа

**Датасет CHSR - [Classification of Heart Sound Recordings](https://www.physionet.org/content/challenge-2016/1.0.0/)**
- датасет открытый, доступный для обучения новых моделей с 2016-го года
- в этом датасете тоже используется другая модель стетоскопа
- 3126 записей сердца, от 5 до 120 секунд, каждая запись - исследование одного пациента, однако один пациент может иметь несколько записей либо в train либо в val наборе
- все записи есть в wav формате
- Конкретные болезни сердца у пациентов не описаны в разметке, поэтому датасет полезен только на первом этапе работы
- Некоторые записи подвержены шуму, человеческой речи и другим значениям, которые могут быть отмечены как "неуверенные", что полезно на нескольких этапах проекта
- Датасет изначально создан для соревнования сегментации шумов и классификации звуков сердца на MatLab


#### 2.3 Подготовка прогнозных моделей

- В качестве метрик и лосс функций будут использованы описанные в пункте [1.2](#12-бизнес-требования-и-ограничения-)
- Валидация будет проходить на собранном датасете ACD + аудио из открытых источников здоровых пациентов.
- В качестве предобработки все данные будут приводиться к одной длине относительно времени, при которой классификация может работать корректно (50с)

Бейзлайн:
- будет использована готовая [модель с huggingface](https://huggingface.co/Hemg/heartbeat-detection-8) для определения пульса пациента 
- будет использована предобученная модель для классификации шумов
- на основе полученных результатов будет подбираться текстовая рекомендация для лечащего врача

Риски данного этапа:
- на данный момент есть трудности с поиском открытых данных, несмотря на количество статей о таковых. В первую очередь будет рассмотрен [датасет с соревнований в kaggle](https://www.kaggle.com/datasets/arashnic/lung-dataset).
- датасеты должны дополнительно проверяться узкими специалистами, что может увеличить время на разработку.
- большинство открытых моделей требуют дообучения на специфических данных.

### 3 MVP
#### 3.1 Способ оценки

#### 3.2 Что считаем успешным окончанием этапа

#### 3.3 Подготовка MVP 


### 4 Внедрение\продакшн

#### 4.1 Архитектура решения

#### 4.2 Описание инфраструктуры и масштабируемости

Будет поднят docker на сервере клиента для удобства обслуживания
Плюсы:
- легко перезапускать
- легко обновлять софт
- не требуется создавать отдельный софт только для медицинского прибора

Минусы:
- надобность интернета для получения результатов, на выездах такое не всегда возможно
- скорость работы будет медленнее чем рип использовании локального софта

В итоге пока планируется данный вариант как наиболее быстрый и удобный

#### 4.3 Требования к работе системы

